From 38ff58f22efbf2beaf10d22de7b6e68215cdd600 Mon Sep 17 00:00:00 2001
From: Cristian Le <git@lecris.dev>
Date: Thu, 20 Mar 2025 10:40:03 +0100
Subject: [PATCH] Expose Fortran install module dir

---
 CMakeLists.txt     | 5 +++++
 src/CMakeLists.txt | 4 +++-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 11acad20..954ed2c1 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -19,6 +19,11 @@ option(ENABLE_SCALAPACK_MPI "Enable parallelisation with ScaLAPACK/MPI")
 CMAKE_DEPENDENT_OPTION(ENABLE_ELSI "Enable ELSI interface" OFF ENABLE_SCALAPACK_MPI OFF)
 option(ENABLE_C_API "Enable C API" ON)
 
+set(CMAKE_INSTALL_MODULEDIR ${CMAKE_INSTALL_INCLUDEDIR}
+    CACHE STRING
+    "Fortran module installation path (Not a cmake native variable)"
+)
+
 option(BUILD_SHARED_LIBS "Build shared rather than static library" ON)
 
 set(DEFAULT_BUILD_TYPE "Release")
diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 6dcd03dd..061e9ce5 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -52,6 +52,7 @@ endif()
 
 set(moduledir "${CMAKE_CURRENT_BINARY_DIR}/modules")
 set(includedir "${CMAKE_INSTALL_INCLUDEDIR}/mbd")
+set(install_moduledir "${CMAKE_INSTALL_MODULEDIR}/mbd")
 set_target_properties(mbd PROPERTIES Fortran_MODULE_DIRECTORY "${moduledir}")
 
 target_include_directories(mbd
@@ -60,6 +61,7 @@ target_include_directories(mbd
     INTERFACE
         $<BUILD_INTERFACE:${moduledir}>
         $<INSTALL_INTERFACE:${includedir}>
+        $<INSTALL_INTERFACE:${install_moduledir}>
 )
 
 if(ENABLE_SCALAPACK_MPI)
@@ -89,6 +91,6 @@ if(CMAKE_INSTALL_LIBDIR)
         ARCHIVE DESTINATION "${CMAKE_INSTALL_LIBDIR}"
         PUBLIC_HEADER DESTINATION "${includedir}"
     )
-    install(DIRECTORY "${moduledir}/" DESTINATION "${includedir}")
+    install(DIRECTORY "${moduledir}/" DESTINATION "${install_moduledir}")
     install(EXPORT MbdConfig NAMESPACE Mbd:: DESTINATION "${CMAKE_INSTALL_LIBDIR}/cmake/mbd")
 endif()
